---
title: "analysis"
author: "Jens Joschinski"
date: "April 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RCurl)
library(readr)
library(data.table)
library(textreadr)
library(tidyr)
library(dplyr)
library(stringr)
library(magrittr)
library(geomapdata)
library(geosphere)
library(MASS)
```

# General description  
## Aim  
The aim of this project is to correlate climate variability with variability in seasonal timing. Is the slope in seasonal responses a bet-hedging trait, i.e., is it adaptive to spread one's timing in more variable conditions?  


### Overview  

Previous scripts calculated winter variability and winter predictability based on climate station data (30k stations), and various parameters of photoperiodic response curves from published studies (350 populations, 61 studies). This script analyses these datasets.


### Specific description  

The data was generated with R version `r getRversion()`. It requires the datasets "01climate_data/03output/results.txt" and "02studies/02output/slopes.txt", and the locations.txt file from the NOAA server.

### Script  

Load the datasets
```{r}
url<-"ftp://ftp.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd-stations.txt"
#this dataset is fixed-width delimited, requiring a few additional steps
locations<-read.fwf(
  file=url
  ,sep="!",na.strings=c("NA","-999.9"), #sep = ! because ! does not exist in dataset - > dataset is fixed-width and should have no additional separators
  widths=c(11, 9, 10, 7,2,35)
)
reslist<-read.table("01climate_data/03output/results.txt")
names(reslist)<-c("ID","meanwinter","sd_winter","nyears","predictability","amplitude","phase angle", "intercept")
climate<-merge(locations,reslist,by=1)
rm(locations)
rm(reslist)
names(climate)<-c("ID","lat","lon","alt","no_idea","name","meanwinter","sd_winter", "nyears","unpredictability","amplitude","phase angle", "intercept")

slopes<-read.table("02studies/02output/slopes.txt")
```

###correlation latitude - CDL

The critical day length (day length at which 50 % of all offspring switch to diapause) should correlate with latitude. Earlier studies quote rates of 1-1.5 hours per 5°N. Let's see if that holds for the data in this meta-analysis:

```{r}
r2<-slopes
r2<-r2[-c(1),]
r2<-separate(r2,col=1, into = c("study","pop"), sep ="-",remove=FALSE)
r2$e<-as.numeric(r2$e)
r2$degN<-as.numeric(r2$degN)
r2$e[r2$e>100]<-NA
r2$degN[r2$degN>80] <- NA
r2$study[r2$study=="6b"]<-6
r2$study<-as.integer(r2$study)
#png("cdl_vs_lat.png")
plot(r2$e~r2$degN, bg = r2$study,pch=22,main = "Correlation of critical day length and latitude", xlab ="latitude",ylab="critical day length")
M<-lm(r2$e~r2$degN, weights = as.numeric(r2$e_rel))
abline(M)
coef(M)[2]*5  #0.93 hours per 5 degree latitude
text(20,24, "slope = 0.93 hours/5°N\nR²=0.58")

#dev.off()
r2$e_rel<-as.numeric(r2$e_rel)
r2$e_rel[r2$e_rel>3000]<-3000
r2$e_rel2<-sqrt(r2$e_rel)/max(sqrt(r2$e_rel),na.rm=T)

#png("cdl_vs_lat_weighted.png")
plot(r2$e~r2$degN, bg = "grey",pch=21,cex=r2$e_rel2+0.5, main = "delay in photoperiodic response vs latitude", xlab = "Latitude (°N)", ylab = "Critical photoperiod")
M<-lm(r2$e~r2$degN, weights = as.numeric(r2$e_rel))
abline(M,lty=2)
coef(M)[2]*5  #0.93 hours per 5 degree latitude
for( i in 2:length(unique(r2$study))){
  a<-r2[r2$study==unique(r2$study)[i],]
  a<-a[is.na(a$e)== FALSE,]
  a<-a[is.na(a$degN)==FALSE,]
  points(a$e~a$degN, pch=21, bg=i,cex=a$e_rel2+0.5)
  M<-lm(a$e~a$degN,weights=as.numeric(a$e_rel))
 lines(x= a$degN,y= predict(M),col="grey",xpd=T)
}
text(20,24, "slope = 0.93 hours/5°N\nR²=0.39")
#dev.off()

#actually the relationship does not seem to be linear
boxcox(r2$e~r2$degN)
M1<-lm(r2$e~r2$degN)
M2<-lm(r2$e^0.465 ~ r2$degN)
#plot(M1)
#plot(M2)
summary(M1)
summary(M2)
#not much difference, can keep linear model
```

The estimate of 1 h per 5° N is not too bad, overall diapause becomes 50 min earlier per 5°.


One would expect that this curve fits well to mean winter onset given latitude, and the climate data allows testing that.

```{r}
plot(climate$meanwinter~climate$lat,pch=22,cex=0.1, main ="Mean winter onset vs. latitude")
M<-lm(climate$meanwinter~climate$lat)
```

Mean winter decreases by 2.5 days per ° latitude = 12.5 days per 5°, so an organism needs to react to a day length equal to 12.5 days per earlier in the year per 5°N. correct calculation of day length at a given latitude for a given day: https://en.wikipedia.org/wiki/Sunrise_equation
luckily there is a package that solves that:

```{r}
M<-lm(climate$meanwinter~climate$lat)
#expected_dl = daylength(latitude,day)
#with day = day from regression on M +182 days because the "year" calculated from climate data starts in july
slopes$expdl<-daylength(slopes$degN,
              182+coef(M)[1]+coef(M)[2]*slopes$degN
)
#the switch to diapause usually takes some time, e.g. sexual offspring must be produced and mature. lets try 1 - 3 weeks
slopes$expdl7<-daylength(slopes$degN, 182+coef(M)[1]+coef(M)[2]*slopes$degN-7)
slopes$expdl14<-daylength(slopes$degN,182+coef(M)[1]+coef(M)[2]*slopes$degN-14)
slopes$expdl21<-daylength(slopes$degN,182+coef(M)[1]+coef(M)[2]*slopes$degN-21)
plot(slopes$expdl~slopes$degN,main = "how the CDL should vary with latitude",xlab ="latitude",ylab ="expected CDL")
points(slopes$expdl7~slopes$degN,col=2)
points(slopes$expdl14~slopes$degN,col=3)
points(slopes$expdl21~slopes$degN,col=4)
```

integrating this into the curve of CDL vs latitude

```{r}
r2<-slopes
r2<-r2[-c(1),]
r2<-separate(r2,col=1, into = c("study","pop"), sep ="-",remove=FALSE)
r2$e<-as.numeric(r2$e)
r2$degN<-as.numeric(r2$degN)
r2$e[r2$e>100]<-NA
r2$degN[r2$degN>80] <- NA
r2$study[r2$study=="6b"]<-6
r2$study<-as.integer(r2$study)
#png("cdl_vs_lat.png")
plot(r2$e~r2$degN, bg = r2$study,pch=22,main = "Correlation of critical day length and latitude", xlab ="latitude",ylab="critical day length")
points(x=r2$degN, y = r2$expdl,cex=0.3)
#points(r2$expdl7~r2$degN,col=2,cex=0.3)
#points(r2$expdl14~r2$degN,col=3,cex=0.3)
points(r2$expdl21~r2$degN,col=4,cex=0.3)


plot(r2$e~r2$expdl,main = "Correlation of Critical day length and expected CDL",xlab ="expected by climate data",ylab="CDL from studies")
abline(lm(r2$e~r2$expdl))
summary(lm(r2$e~r2$expdl))
```


Now to the main part of this study: ccorrelating slope of the PRC with climate data

1. histograms of all variables

```{r}
hist(r2$alt)
r2$alt[r2$alt==-999.9]<-NA
r2$sq_alt <-sqrt(r2$alt)
hist(r2$sq_alt,breaks=100)

hist(r2$meanwinter,breaks=100)
hist(r2$sd_winter,breaks=100)
r2$capped_sd<-r2$sd_winter
r2$capped_sd[r2$capped_sd>50]<-50

hist(r2$nyears,breaks=50)

hist(r2$unpredictability,breaks=100)
sum(!is.na(r2$unpredictability))
sum(is.na(r2$unpredictability))
length(r2$unpredictability[r2$unpredictability>5])-3911
97/16923 #0.5% of all values are >5, 1.1%>4
hist(r2$unpredictability[r2$unpredictability<5],breaks=100)


p<-r2

hist(p$amplitude)
hist(p$`phase angle`)
hist(p$intercept)



#checking whether the nls regression makes sense

p$intercept[p$intercept<(-100)]<-(-100)
p$intercept[p$intercept>200]<-200
p$intercept<-p$intercept+abs(min(p$intercept))
p$amplitude[p$amplitude>250]<-250
plot(p$lat~p$lon,bg = rgb(p$intercept,0,p$intercept,maxColorValue = max(p$intercept)),col=NA,pch=22,cex=0.3)
plot(p$lat~p$lon,bg = rgb(p$amp,0,p$amp,maxColorValue = max(p$amp)),cex=0.3,pch=22,col=NA)
plot(p$lat~p$lon,bg=rgb(p$`phase angle`,0,p$`phase angle`,maxColorValue = max(p$`phase angle`)),cex=0.3,pch=22,col=NA)


#visualisation mean winter, sd(winter), predictability
png("mean-winter.png")
p<-r2
p<-p[!is.na(p$meanwinter),]
plot(p$lat~p$lon,bg = rgb(p$meanwinter,p$meanwinter,0,maxColorValue = max(p$meanwinter)),cex=0.3,pch=22,col=NA, main ="mean winter onset",xlab="",ylab="")
dev.off()

p<-r2
p<-p[!is.na(p$capped_sd),]
p$capped_sd[p$capped_sd>20]<-20
p<-p[p$nyears>8,]
png("sd-winter.png")
plot(p$lat~p$lon,bg = rgb(p$capped_sd,p$capped_sd,0,maxColorValue = max(p$capped_sd)),cex=0.3,pch=22,col=NA, main ="sd winter onset, capped at 20",xlab="",ylab="")
dev.off()

p<-p[!is.na(p$sq_alt),]
M<-lm(p$sd_winter~p$lat+p$sq_alt)
summary(M)#R²=0

p<-r2
p<-p[!is.na(p$unpredictability),]
p<-p[p$nyears>5,]
p$unpredictability[p$unpredictability>5]<-5 #0.5% of all data
range(p$unpredictability)
png("predictability-winter.png")
plot(p$lat~p$lon,bg = rgb(p$unpredictability,p$unpredictability,0,maxColorValue = max(p$unpredictability)),cex=0.3,pch=22,col=NA, main ="unpredictability",sub="dark low standard deviation in slopes",xlab="",ylab="")
dev.off()



summary(lm(p$unpredictability~p$lat+p$lon+p$sq_alt))
summary(lm(p$unpredictability~p$lat+p$lon+p$alt))
summary(lm(p$unpredictability~p$amplitude))
r<-resid(lm(p$unpredictability~p$sq_alt))
```