---
title: "analysis"
author: "Jens Joschinski"
date: "April 5, 2018"
output:     
  md_document:
        variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(maps)
library(geosphere)
library(fcuk)
library(glmmTMB)
library(metafor)

#library(RCurl)
#library(readr)
#library(data.table)
#library(textreadr)
#library(tidyr)
#library(dplyr)
#library(stringr)
#library(magrittr)
#library(geomapdata)
#library(MASS)
#library(ggplot2)
#library(MuMIn)
#library(sjstats)
```


# General description  
## Project aim  
To understand the evolvability of phenological strategies such as plasticity and bet-hedging, we correlate reaction norm properties with climate parameters. 

## Script overview  

Previous scripts calculated winter onset means and predictability based on climate station data (30k stations), and various parameters of photoperiodic response curves from published studies (447 reaction norms). This script analyses these datasets.


### Specific description  

The data was generated with R version `r getRversion()` (3.4.3). It requires the datasets "/nov2018/lit_extract/mcmcresults.txt", "/nov2018/clim_calc/output/beta.txt" and "[...]/output/results_100_5.txt", and the locations.txt file from the NOAA server.

In this script we do:
1. maps of winter onset and winter predictability (day length and 2x temperature)

2a. correlate critical day length (CDL) with latitude
2b. correlate day length of mean winter onset with latitude. 

3. correlate mean diapause timing with mean winter onset
4. correlate the residuals of 3) with day length predictability
...

 
### statistical approaches  
The correct statistical approach should be:

estimate ~ climate data, random = order/genus/species/study/population)

with the estimate weighted by the inverse variance. However, there is little replication on the species level (usually 1 study per species, if more then by same authors) and on the genus level (usually very few genera per order, or each genus with its own species), so the terms study and genus will be dropped.

# Script  
## load data

The data with the mcmc results needs to be loaded. This has for each of the 447 reaction norms the estimate of mean, vairance within and variance among environments, the ratio, the sum and of course credible intervals for all. var between = sd(percentages)^2 across environments, var within = sum(percentages * (1-percentages))/n.

```{r load_studies}
studies <- read.table("lit_extract/mcmcresults.txt")
studies<-studies[order(studies$order),]
studies$col<-as.numeric(studies$order)
studies$col<-hsv(studies$col/10,1,1)
##constrain to between tropics and polar circle
#studies <- studies[between(studies$degN, 23.434, 66.57),]

#data structure: 447 rows, 33 variables

#names of cols:
#popid: unique identifier of the reaction norm (447 levels)
#order: insect or mite order (9 levels)
#ID: first author of study from which reaction norm comes. 57 levels, because each study has multiple reaction norms
#PY: publication year of study
#pops_left_drc: number of populations within each study. Not necessarily equal to number of reaction norms, e.g. lehmann has 6 reaction norms from 5 populations (in total there are 447 reaction norms for 402 populations)
#region: larger geographical region from which population comes (e.g. Europe, Japan...)
#genus: genus name
#spec: species name
#nmethod: how detailed are sample sizes described in the study? usually "global average", e.g. "on average there were 100 beetles used for each population and day length"
#degN: Latitude of sampling location; range = 14.3 : 69.05
#degE: Longitude of sampling location; range = -123 : 144 (US to Japan)
#n_pp: number of available photoperiod treatments for this reaction norm. The reaction norm was reconstructed based on 3-21 data points, average 7.12

#col: color gradient based on order as defined above

#med_r: variance composition estimate (among/(within + among), eq. 4)
#lower_r, upper_r: credible interval range of med_r
#med_s: estimate for sum of variance components (phenotypic variance, eq. 5)
#med_b: variance among estimate, eeq.3
#med_w: variance_within estimate, eq. 2
#med_e: mean estimate (parameter e in the logit curve, eq.1)


#order.x, order.y...; n: became meaningless, not required anymore
```



## climate data  
As climate dataset I chose the parameters (5 days below 10°C), a combination that is close to e.g. halkett 2004, and results in a mean winter onset in mid-october (when many animals start their diapause). the climate dataset "results_100-5.txt" has mean winter onset, standard deviation in winter onset ( measure of day length predictbaility), and predictability based on standard deviation of slopes of a temperature regression. The dataset "beta.txt" adds a colour of noise approach. the file ghcnd-stations.txt has latitudes and longitutes. These files will now be merged

```{r load_climate}
url<-"ghcnd-stations.txt"
#"ftp://ftp.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd-stations.txt"
#this dataset is fixed-width delimited, requiring a few additional steps
locations<-read.fwf(
  file=url
  ,sep="!",na.strings=c("NA","-999.9"), #sep = ! because ! does not exist in dataset - > dataset is fixed-width and should have no additional separators
  widths=c(11, 9, 10, 7,2,35)
)

reslist<-read.table("clim_calc/output/results_100-5.txt",na.string = c("NA","-9999","-999.9"))
names(reslist)<-c("ID","meanwinter","sd_winter","p","nyears","ndays_300","ndays_350","ndays_365")
reslist<-reslist[1:26804,] #the same data was appended twice
climate<-merge(locations,reslist,by=1)
rm(reslist)
names(climate)<-c("ID","lat","lon","alt","name","no_idea","meanwinter","sd_winter", "p",  "nyears" ,  "ndays_300"  ,"ndays_350",  "ndays_365" )

climate<-climate[!is.na(climate$meanwinter),] #because these cannot be used anyway
beta<-read.table("clim_calc/output/beta.txt",header=T)
climate<-merge(climate,beta,by=1)

climate<-climate[climate$lat<70,] #at higher latitudes winter onset is at midsummer

#calculate day length:
#Day length changes not only with latitude but also with day of year
#The correct calculation of day length at a given latitude for a given day is difficult: https://en.wikipedia.org/wiki/Sunrise_equation
#luckily there is a package that solves that.
climate$dl <- daylength(climate$lat,climate$meanwinter+182)
```



## 1. maps  
MAking worldwide maps of winter onset, sd(winter onset) etc 
```{r individual_maps}
plotmap<-function(r,g,b){
  par(fg = "darkgrey")
  map("world",xlim= c(-160, 150),ylim = c(0,75), interior=T, fill=T, bg = "white",col ="darkgrey")
  points(x= climate$lon, y= climate$lat, col = NA, bg = rgb(r,g,b,maxColorValue = 255), pch = 22,  cex=0.5)
  points(x = studies$degE, y= studies$degN, col =1, pch=4, cex = 0.5)
}


#winter onset
x<-climate$meanwinter
x<-x-min(x)
x<-x/(max(x)) #values between 0 and 1
#large values (winter is late in year, high number) should be red
#range should be: 192,0,0 (red) to 30,100,200 (blue)

r<- x * 162
r <- r + 30
g<-100 - (x * 100)
b<-200 - (x * 200)
svg("w_on_10C5d.svg", width = 14, height = 7, pointsize=12)
plotmap(r,g,b)
dev.off()


### day length at winter onset###
x<-climate$dl
length(x[x>16])/length(x)
x[x>16]<-16
x<-24-x #x is night length now, high values = short days
#high values should be red ( winter very late in year, under very short days)
x<-x-min(x)
x<-x/(max(x)) #values between 0 and 1

r<- x * 162
r <- r + 30
g<-100 - (x * 100)
b<-200 - (x * 200)
svg("w_dl_10C5d.svg", width = 14, height = 7, pointsize=12)
plotmap(r,g,b)
dev.off()

###winter predictability by day length###
x<-climate$sd_winter
x[x>30]<-30 #capped to make plotting sensible
x<-x-min(x)
x<-x/(max(x)) #values between 0 and 1
#large values (high standard deviation) should be red

r<- x * 162
r <- r + 30
g<-100 - (x * 100)
b<-200 - (x * 200)
svg("w_sd_10C5d.svg", width = 14, height = 7, pointsize=12)
plotmap(r,g,b)
dev.off()


###predictability by temperature###
#This way of calculating winter unpredictability is the standard deviation in slopes of a temperature regression, 30 days before winter onset of each year
#x<-climate[!is.na(climate$p),]
x<-climate$p
length(x[x>4])/length(x)
x[x>4]<-4 #capped to make plotting sensible
x<-x-min(x,na.rm=T)
x<-x/(max(x,na.rm=T)) #values between 0 and 1
#large values (high standard deviation) should be red

r<- x * 162
r <- r + 30; r[is.na(r)]<-0
g<-100 - (x * 100); g[is.na(g)]<-0
b<-200 - (x * 200); b[is.na(b)]<-0
svg("w_p_10C5d.svg", width = 14, height = 7, pointsize=12)
plotmap(r,g,b)
dev.off()


###predictability as colour of noise###
x<-climate[!is.na(climate$beta),]
nrow(x[x$beta>2,])/nrow(x)
x$beta[x$beta>2]<-2 #capped to make plotting sensible
x$beta[x$beta<(-2)]<-(-2) #capped to make plotting sensible
x$beta<-x$beta-min(x$beta)
x$beta<-x$beta/(max(x$beta)) #values between 0 and 1
#large values (high standard deviation) should be red

r<- x$beta * 162
r <- r + 30
g<-100 - (x$beta * 100)
b<-200 - (x$beta * 200)
svg("w_b_10C5d.svg", width = 14, height = 7, pointsize=12)
plotmap(r,g,b)
dev.off()
```


all maps in one figure (code is essentially copy of above)
```{r all_maps}
plotmap<-function(r,g,b){
  map("world",xlim= c(-160, 150),ylim = c(0,75), interior=T, fill=T, bg = "white",col ="darkgrey")
  points(x= climate$lon, y= climate$lat, col = NA, bg = rgb(r,g,b,maxColorValue = 255), pch = 22,  cex=0.5)
  points(x = studies$degE, y= studies$degN, col =1, pch=4, cex = 0.5)
}

svg("all.svg", width = 14*360/310, height = 7*2.4, pointsize=12)
  par(fg = "darkgrey", mfrow = c(4,1),mar=c(0,0,0,0))


### day length at winter onset###
x<-climate$dl
length(x[x>16])/length(x)
x[x>16]<-16
x<-24-x #x is night length now, high values = short days
#high values should be red ( winter very late in year, under very short days)
x<-x-min(x)
x<-x/(max(x)) #values between 0 and 1

r<- x * 162
r <- r + 30
g<-100 - (x * 100)
b<-200 - (x * 200)
plotmap(r,g,b)
rect(-163,0-1.38,153,75+1.38,col=NA,border = 1 ,xpd=T)
text(-160,10,"A",pos=4,cex=4, col=1)

###winter predictability by day length###
x<-climate$sd_winter
x[x>30]<-30 #capped to make plotting sensible
x<-x-min(x)
x<-x/(max(x)) #values between 0 and 1
#large values (high standard deviation) should be red

r<- x * 162
r <- r + 30
g<-100 - (x * 100)
b<-200 - (x * 200)
plotmap(r,g,b)
rect(-163,0-1.38,153,75+1.38,col=NA,border = 1 ,xpd=T)
text(-160,10,"B",pos=4,cex=4, col=1)

###predictability by temperature###
#This way of calculating winter unpredictability is the standard deviation in slopes of a temperature regression, 30 days before winter onset of each year
#x<-climate[!is.na(climate$p),]
x<-climate$p
length(x[x>4])/length(x)
x[x>4]<-4 #capped to make plotting sensible
x<-x-min(x,na.rm=T)
x<-x/(max(x,na.rm=T)) #values between 0 and 1
#large values (high standard deviation) should be red

r<- x * 162
r <- r + 30; r[is.na(r)]<-0
g<-100 - (x * 100); g[is.na(g)]<-0
b<-200 - (x * 200); b[is.na(b)]<-0
plotmap(r,g,b)
rect(-163,0-1.38,153,75+1.38,col=NA,border = 1 ,xpd=T)
text(-160,10,"C",pos=4,cex=4, col=1)

###predictability as colour of noise###
x<-climate[!is.na(climate$beta),]
nrow(x[x$beta>2,])/nrow(x)
x$beta[x$beta>2]<-2 #capped to make plotting sensible
x$beta[x$beta<(-2)]<-(-2) #capped to make plotting sensible
x$beta<-x$beta-min(x$beta)
x$beta<-x$beta/(max(x$beta)) #values between 0 and 1
#large values (high standard deviation) should be red

r<- x$beta * 162
r <- r + 30
g<-100 - (x$beta * 100)
b<-200 - (x$beta * 200)
plotmap(r,g,b)
rect(-163,0-1.38,153,75+1.38,col=NA,border = 1 ,xpd=T)
text(-160,10,"D",pos=4,cex=4, col=1)


```



## 2. Critical day length and latitude  

According to Danilevsky, day  length should shift by 1-1.5 hours per 5°N. Let's see if that holds for the data in this meta-analysis.

#### the full model  
```{r degN_full}
r<-studies$upper_e-studies$lower_e
quantile(r,0.2)#20% have credible interval < 10 minutes

r[r<(1/6)]<-1/6  #all reaction norms with credible interval of 10 min or less have same weight
vi <- (r / (2*1.96))^2 #calculation of variance from CI


metaf<-rma.mv(yi = med_e ~ degN, V=1, random = ~1|order/genus/spec/ID/popid,data = studies) 
#this model does not actuallz use vi, but is an unweighted version. But general problems should be similar in weighted model
#profile(metaf,sigma2 = 1)
#profile(metaf,sigma2 = 2)
#profile(metaf,sigma2 = 3)
#profile(metaf,sigma2 = 4)
#this model has very little vraiance explained by ID and popid, because spec and genus absorb most of it

```

There are just not enough replicate studies per species, not enough species per genus (usually), and not enough genera per order. studies on the smae species were usually conducted by the same authors, so ID can be safely removed. This assumes that different studies on the same species will give the same results. Genus can also be removed.

### the reduced model
```{r degN_models}

metaf<-rma.mv(yi = med_e ~ degN, V=vi, random = ~(1|order/spec/popid), data = studies)



#null models and ML models (weighted)
metanull<-rma.mv(yi = med_e ~ 1, V=vi, random = ~(1|order/spec/popid), data = studies)
metaf.ml<-rma.mv(yi = med_e ~ degN, V=vi, random = ~1|order/spec/popid,data = studies, method = "ML") 
metanull.ml<-rma.mv(yi = med_e ~ 1, V=vi, random = ~1|order/spec/popid,data = studies,method = "ML") 


n<-table(studies$order)
names(n)<- paste(names(n)," (", n, ")", sep = "") #will be used for plotting later, better laod it together with the model so it wont get lost
```

_summary statistics_    
```{r degN_sumstat}
#summary statistics
quantile(studies$degN)
#      0%      25%      50%      75%     100% 
#14.30000 34.55186 38.92000 44.88400 69.04917 

mean(studies$degN) #  41.38953 mean latitude of studies
mean(studies$med_e) # 13.74073 mean day length of diapause induction

x<-daylength(41,1:360)  #day length throughout the year at 41°N
which(x>13.7&x<13.8) #day 230 at 41 °N = Aug 18

#estimate +se
summary(metaf)
#Model Results:#

#         estimate      se     zval    pval   ci.lb   ci.ub     
#intrcpt    7.0540  0.3909  18.0452  <.0001  6.2878  7.8201  ***
#degN       0.1612  0.0067  24.1200  <.0001  0.1481  0.1743  ***
#48.36 min per 5 deg N

plot(resid(metaf))

#nakagawas R²
(metanull$sigma2-metaf$sigma2)/metanull$sigma2 # -2510129.58        0.66        0.60
(sum(metanull$sigma2)-sum(metaf$sigma2))/sum(metanull$sigma2) #0.55

#significance testing
anova(metaf.ml,metanull.ml) #LRT ratio = 364.9981, p<.0001
AIC(metaf.ml)-AIC(metanull.ml)#    -362.9981
```




### plot  
Plot critical day length vs latitude, with character size proportional to weight, with credible intervals around the points, and different colours for different orders.
```{r degN_plot}
studies$r<-r

svg("CDL_lat.svg",width=10,pointsize=12)
par(mar = c(5,5,0,0)+0.1)

max.size<-((1/6)/(2*1.96))^2; max.size <- 1/max.size #minimum credible interval range was capped at 1/6 (10 min) to prevent infinite weights. this line calculates variance for this value; it will be used to control the point cex in the plot
plot(x=studies$degN, y=studies$med_e, pch=21, cex=0.3+1.5*(1/vi)/max.size, col=1, bg=studies$col, main = "", xlab = "Latitude (°N)", ylab = "Critical photoperiod (h)",bty="n", xaxt="n", cex.axis = 1.5, cex.lab=1.5) #cex ranges from 0.3 to 1.5, with 1.5 for those with heighest weight (ci = 10 min)
legend("topleft",legend=names(n), col=rep(1,8), pt.bg=unique(studies$col), pch=21, bty="n", ncol=1,cex=1.5)
coffs <-  coef(metaf)
coffs
#  intrcpt      degN 
#7.0539704 0.1611997 

lines(x= range(studies$degN),y = coffs[1]+coffs[2]*range(studies$degN),lwd=3,lty=1)


axis(1,at=c(0,20,30,40,50,60,70,80),cex.axis=1.5, cex.lab = 1.5)


function(notneeded){for(i in 1:9){ #prints individual lines per order, not needed currently
  sub<-studies[studies$order==unique(studies$order)[i],]
  sinord<-lm(med_e ~ degN, data=sub, weights=r)
  coffs <-  coef(sinord)
  lines(x= range(sub$degN),y = coffs[1]+coffs[2]*range(sub$degN), lwd= 1+round(5* table(studies$order)[i]/max(table(studies$order))), col=sub$col[1])
  print(sub$order[1])
  print (paste("slope: ",(coffs[1]*5*60), "se: ", (coffs[2]*5*60)))
}}

segments(x0=studies$degN[studies$r<2], y0 = studies$upper_e[studies$r<2], y1=studies$lower_e[studies$r<2] ,col="darkgrey") #only credible intervals <2 hours are printed, otherwise fig would be cluttered

ord<-studies[order(studies$r,as.numeric(studies$order),decreasing = c(T,F), method = "radix"),] #to make sure smalles points are printed last, on top of the larger points. order is included so that dipterans do not completely dominate pic
vi.new <- (ord$r / (2*1.96))^2
for (i in 1:nrow(ord)){
  points(x=ord$degN[i] ,y=ord$med_e[i], pch=21, col=1, bg=ord$col[i], cex=(0.3+1.5*(1/vi.new)/max.size)[i])
}

dev.off()

#many points add very little to the graph - how many exactly?
x<-cumsum(1/vi[order(1/vi,decreasing = T)])#order 1/vi, calculate cumSum
#plot(x) the first ~180 points have large influence, then influence decreases rapidly
which.min(x<sum(1/vi)*0.9) #the points 1:186 account for 90% of the total weight
186/447 #40% of the points account for 90% of the total weight
```
In contrast to Danilevsky, we find only a linear change of 48 minutes per 5°N. 




## add climate data to studies

Climate data stations were not necdssarily close to the sampling sites. Solution: Take average climate data from stations within 5° latitude, weighted by euclidian distance
```{r combine}
studies$meanwinter<-NA
studies$sd_winter<-NA
studies$p<-NA
studies$nyears<-NA
studies$beta<-NA 
studies$sd_sd<-NA #standard deviation in winter predictabilities of nearby stations
studies$n_s<-NA

for ( i in 1:nrow(studies)){
  #reduce to +-5 °
  sub<-climate[between(climate$lat,studies[i,"degN"]-5,studies[i,"degN"]+5)& between(climate$lon,studies[i,"degE"]-5,studies[i,"degE"]+5),]

    sub$diffN<-sub$lat-studies[i,"degN"] #calculate distance in latitude
    sub$diffE<-sub$lon-studies[i,"degE"] #same for longitude
    sub$diff<-sqrt(sub$diffN^2+sub$diffE^2) #euclidian distance

    sub<-arrange(sub,diff)[1:5,] #sort and take 5 lowest values = 5 closest stations
  

  
  studies$meanwinter[i]<-weighted.mean(sub$meanwinter,1/sub$diff)
  studies$sd_winter[i]<-weighted.mean(sub$sd_winter,1/sub$diff)
  studies$p[i]<-weighted.mean(sub$p,1/sub$diff)
  studies$nyears[i]<-weighted.mean(sub$nyears,1/sub$diff)
  studies$beta[i]<-weighted.mean(sub$beta,1/sub$diff)
  studies$sd_sd[i]<-sd(sub$sd_winter) #quality control. the predictability of nearby stations should be similar to each other
  studies$n_s <- nrow(sub) #a location may not have 5 stations around

}
studies[is.na(studies$meanwinter),]
#435 studies have climate stations within 5°
#mostly small japanese islands missing
```

```{r remove_noclim}
studies<-studies[!is.na(studies$meanwinter),] #435 left
```


### correlation day length at winter onset with latitude  

The relationship of CDL ~ latitude was smaller than expected. Given the climate data, what is the optimal diapause shift with latitude?

```{r cor}
svg("corr_dl_lat_10C5d.svg")
par(mar=c(5,5,3,2)+0.1)
plot(climate$dl[!between(climate$lat, 21, 69)]~climate$lat[!between(climate$lat, 21, 69)], pch=22,cex=0.2,xlab = "Latitude",ylab = "Day length at winter onset",main="",col=NA,bg="darkgrey",bty="n",yaxt="n",cex.axis=1.5,cex.lab=1.5,ylim = c(9,24))
axis(2,at=c(4,8,12,16,20,24),cex.axis=1.5)
climred<-climate[between(climate$lat, 21,69),]
points(climred$dl~climred$lat, pch=22, cex=0.2, bg=1, col=NA)
M<-lm(climred$dl~climred$lat)
lines(x=c(21,69),y=coef(M)[1]+c(21,69)*coef(M)[2],lwd=4,col="darkgrey")

dev.off()
coef(M)[2]*5 *60#    46.3433 

#once more, but only for study sites
studies$expdl<-daylength(studies$degN,studies$meanwinter+182)
par(mar=c(5,5,3,2)+0.1)
plot(studies$expdl~studies$degN,pch=22,cex=1,xlab = "Latitude",ylab = "Day length at winter onset",main="",bty="n",yaxt="n",cex.axis=1.5,cex.lab=1.5,bg=1,col=1)
axis(2,at=c(4,8,12,16,20,24),cex.axis=1.5)


M<-lm(studies$expdl~studies$degN)
lines(x=c(20,70),y=coef(M)[1]+c(20,70)*coef(M)[2],lwd=4,col="darkgrey")
coef(M)[2]*5*60 # 44.68448 

```
We calculated the optimal response based on climate data as 0.74 h/5°N = 46.34 min. If only the study sites are included, this changes to 44.68 min.  Oviously the estimates are very coarse because they are exponential, but danilevskys values of 1h - 90 min are definitely too high. Indeed the expected values are very close to the observed response of 48 minutes /5°N.


## 3. Mean winter onset and mean diapaue timing
In the following chunks we will corerlate mean timing with mean winter conditions, expected a close relationship due to genetic tracking

### conversion of CDL to mean winter
To convert CDL to mean winter, we need the latitude. The daylength() function goes wrong way (day -> day length), so we need to inverse it
```{r model_means}
studies$mw<-NA
studies$mwl<-NA
studies$mwh<-NA
studies$meanwinter <- studies$meanwinter + 182 #was counted in days since midsummer

for ( i in 1:nrow(studies)){
  x<-daylength(studies$degN[i],173:357) #357 = shortest day of year, 173 = longest
  #plot(x) will show the day length decline from midsummer to midwinter for a given latitude. We need to find the x value which is closest to the CDL, and record on which day it occurs

  studies$mw[i]<-which.min(abs(studies$med_e[i] - x))+173 -1 #day 173 is at x == 1 ,this is why 1 is substracted
  studies$mwl[i]<-which.min(abs(studies$lower_e[i] - x))+172
  studies$mwh[i]<-which.min(abs(studies$upper_e[i] - x))+172
}


#some day lengths that were measured in studies do not occur naturally at this latitude: 
table(studies$mw==173) #21
table(studies$mw==356) #4
#they were automatically set to midsummer/midwinter with this algorithm. Same for credible intervals:
table(studies$mwh==173)#53
table(studies$mwl==356) #15
table((studies$mwh==173) & (studies$mwl == 356)) #6


plot(studies$mw~studies$meanwinter,ylim = c(180, 400))
segments(x0=studies$meanwinter, y0 = studies$mwl, y1 = studies$mwh,col="lightgrey")
```


### model mean winter ~ winter_onset  
This is mostly a copy of the cdl ~ latitude part, with only minor changes
```{r model_mw}
r<-studies$mwl-studies$mwh # mwl = winter onset according to lower CDL = later winter onset; so mwl is actually upper limit
mean(studies$med_e)#13.78
c(13.78-1/6, 13.78+1/6) #mean +/- 10 minutes = 13.61, 13.95
daylength(mean (studies$degN), 226:236)
#day length change of 10 minutes is approx 7 days

quantile(r,0.48)#48% have credible interval < 7 days (10 minutes in cdl)

r[r<7]<-7 #changes < 1 wk are irrelevant  
vi <- (r / (2*1.96))^2
mw<-rma.mv(yi = mw ~ meanwinter, V=vi, random = ~(1|order/spec/popid), data = studies)



#null models and ML models (weighted)
mwnull<-rma.mv(yi = mw ~         1, V=vi, random = ~(1|order/spec/popid), data = studies)
mw.ml<-rma.mv(yi = mw ~ meanwinter, V=vi, random = ~1|order/spec/popid,data = studies, method = "ML") 
mwnull.ml<-rma.mv(yi = mw ~      1, V=vi, random = ~1|order/spec/popid,data = studies,method = "ML") 


n<-table(studies$order)
names(n)<- paste(names(n)," (", n, ")", sep = "") #will be used for plotting later, better laod it together with the model so it wont get lost
```

_summary statistics_    
```{r mw_sumstat}
#summary statistics
quantile(studies$mw)
#%  25%  50%  75% 100% 
# 173  217  239  261  356 

mean(studies$mw) #  239.82 = aug 27, 9 days away from estimate based on CDL (some cdl estimates are unreliable because they are longer than natural day lengths at the study location)


#estimate +se
summary(mw)
#Model Results:#

#            estimate       se     zval    pval    ci.lb     ci.ub     
#intrcpt      77.4644  13.7504   5.6336  <.0001  50.5141  104.4147  ***
#meanwinter    0.5201   0.0381  13.6609  <.0001   0.4455    0.5947  ***

plot(resid(mw))

#nakagawas R²
(mwnull$sigma2-mw$sigma2)/mwnull$sigma2  #-0.1418872  0.1212247  0.3551717
(sum(mwnull$sigma2)-sum(mw$sigma2))/sum(mwnull$sigma2) #0.1487213

#significance testing
anova(mw.ml,mwnull.ml) #LRT ratio = 152.6196, p<.0001
AIC(mw.ml)-AIC(mwnull.ml)#     -150.6196

```

Okay the R² is actually worse than for CDL ~ latitude, but more relevant for fitness.

### plot  
```{r plot_mw}
studies$r<-r

svg("mw_meanwinter.svg",width=10,pointsize=12)
par(mar = c(5,5,0,0)+0.1)


max.size<-(7/(2*1.96))^2; max.size <- 1/max.size 

plot(x=studies$meanwinter, y=studies$mw, pch=21, cex= 0.3+1.5*(1/vi)/max.size , col=1, bg=studies$col, main = "", xlab = "Mean winter onset", ylab = "Mean diapause timing",bty="n", cex.axis = 1.5, cex.lab=1.5,xlim=c(170,400), ylim=c(170,400)) #cex again set so that max ptsize = 2

legend("topleft",legend=names(n), col=rep(1,8), pt.bg=unique(studies$col), pch=21, bty="n", ncol=1,cex=1.5)
 
coffs <-  coef(mw)
coffs
#   intrcpt meanwinter 
#77.4392099  0.5201638 
lines(x= range(studies$meanwinter),y = coffs[1]+coffs[2]*range(studies$mw),lwd=3,lty=1)

segments(x0=studies$meanwinter[r<30],y0 = studies$mwl[r<30],y1=studies$mwh[r<30],col="darkgrey") #credible intervals > 1 month are not shown

ord<-studies[order(studies$r,as.numeric(studies$order),decreasing = c(T,F), method = "radix"),] 
vi.new <- (ord$r / (2*1.96))^2

for (i in 1:nrow(ord)){
  points(x=ord$meanwinter[i] ,y=ord$mw[i], pch=21, col=1, bg=ord$col[i],cex=(0.3+1.5*(1/vi.new)/max.size)[i])
}


dev.off()

#many points add very little to the graph - how many exactly?
x<-cumsum(1/vi[order(1/vi,decreasing = T)])
which.min(x<sum(1/vi)*0.9) 
239/447 #53% of the points account for 90% of the total weight
```

Mean winter onset increases roughly linearly with latitude. The critical day length that is associated with it, however, increases exponentially. The insects only respond linearly, so the gap between mean winter onset and mean timing widens with increasing latitude.  This explains why the curve is bent. the ideal line would roughly follow that of mites (which is much steeper) with a slope of 1. My interpretation: either insects cannot their CDL "far enough", i.e. evolutionary constraints, or they co-opt other mechanisms such as cold tolerance
In any case there is a strange intercept that requires explanation, mean diapause timing is ~ 77 days earlier than one would expect. 


## variance composition

```{r}
png("variance_composition.png")
plot(studies$med_s~studies$med_r,xlab="variance composition",ylab ="responsiveness",pch=22, cex=0.5,bg=1)
text(1,0,"plasticity",pos=2)
text(0,0,"bet-hedging",pos=4,xpd=T)
dev.off()
segments(x0 = studies$med_r, y0 = studies$upper_s,y1 = studies$lower_s,col="grey")
segments(x0 = studies$lower_r, x1 = studies$upper_r, y0 = studies$med_s,col="grey")
points(studies$med_s ~ studies$med_r, pch=22, cex=0.5,bg=1)
```


## 4. correlation of responsiveness with winter severity  
Phenotypic variation only makes sense if there is sufficient envrionmental change. Thus responses by either plasticity or bet-hedging should only occur in environments with harsh enough winters (or actually a differenc ebetween summer and winter). for the moment I use mean winter onset as indicator of amplitude, because winter harshness sohuld correlate strongly with that

```{r responsiveness}
r <- studies$upper_s-studies$lower_s
r[r<0.01]<-0.01 #changes < 0.01 are irrelevant
r<-1/r
studies$r<-nrow(studies) * r/sum(r) #1/3 of all points gets full weight
resp<-lme(med_s ~ meanwinter, random =~ 1|order/spec, data=studies, weights=~r, method="REML")


#null model (with species as random)
nullresp<-lme(med_s ~ 1, random =~ 1|order/spec, data=studies, weights=~r, method="REML")

summary(resp)

#as ML fits
resp.ml<-lme(med_s ~ meanwinter, random =~ 1|order/spec, data=studies, weights=~r, method="ML")
nullresp.ml<-lme(med_s ~ 1, random =~ 1|order/spec, data=studies, weights=~r, method="ML")


#estimate +se
summary(resp)$tTable
 #                 Value  Std.Error  DF   t-value      p-value
#(Intercept)  0.3525786037 0.035176447 374 10.023144 4.218810e-21
#meanwinter  -0.0004794173 0.000109729 374 -4.369101 1.618061e-05

plot(resid(resp))


anova(resp.ml,nullresp.ml) #LRT ratio = 17.11208 , p<.0001
AIC(resp.ml)-AIC(nullresp.ml)  #-15.11208

#nakagawas R²
r.squaredGLMM(resp) #0.03990663 0.3437253
#marginal and conditional = without and with random effects
```


plot
```{r}
svg("sums.svg",width=10,pointsize=12)
par(mar = c(5,5,0,0)+0.1)

plot(x=studies$meanwinter, y=studies$med_s, pch=21, cex=studies$r/max(studies$r) * 2, col=1, bg=studies$col, main = "", xlab = "Mean winter onset", ylab = "Sum of varaiance components",bty="n", cex.axis = 1.5, cex.lab=1.5,xlim=c(200,400), ylim=c(0,0.25)) #cex again set so that max ptsize = 2
#legend("bottomright",legend=names(n), col=rep(1,8), pt.bg=unique(studies$col), pch=21, bty="n", ncol=1,cex=1.5)
coffs <-  summary(resp)$tTable
lines(x= range(studies$meanwinter),y = coffs[1,1]+coffs[2,1]*range(studies$meanwinter),lwd=2,lty="dotted")


segments(x0=studies$meanwinter[studies$r>0.2452147],y0 = studies$lower_s[studies$r>0.2452147],y1=studies$upper_s[studies$r>0.2452147],col="darkgrey") #credible intervals > 0.05 not shown
ord<-studies[order(studies$r,as.numeric(studies$order),decreasing = c(T,F), method = "radix"),] #to make sure smalles points are printed last, on top of the larger points. order is included so that dipterns do not completely dominate pic
for (i in 1:nrow(ord)){
  points(x=ord$meanwinter[i] ,y=ord$med_s[i], pch=21, col=1, bg=ord$col[i], cex=ord$r[i]/max(studies$r) * 2)
}
dev.off()
```

### 5. variance composition vs day length predictability

```{r varcomp_sd}
x<-studies # a backup

r <- studies$upper_r-studies$lower_r
r[r<0.05]<-0.05 #changes < 0.05 are irrelevant
vi<- (r / (2*1.96))^2 


mod <- rma.mv(med_r ~ sd_winter,vi, random = ~ 1 | order/spec/popid, data=studies)
plot(rstandard(mod)$z, ylim=c(-3,3), pch=19) #not very nice
studies$yti <- transf.logit(studies$med_r)
studies$vti <- vi / (studies$med_r * (1 - studies$med_r))^2
mod <- rma.mv(yti ~ sd_winter, vti, random = ~ 1 | order/spec/popid, data=studies)

mod
plot(rstandard(mod)$z, pch=19)
plot(studies$sd_winter, studies$yti, pch=19)
x<-seq(5,25,length.out=1000) #will be used to plot prediction line
 y=coef(mod)[1]+x*coef(mod)[2] #inverse logit transform this to get prediction

 
 #null models and ML models (weighted)
modnull<-rma.mv(yti  ~ 1, vi, random = ~(1|order/spec/popid), data = studies)
mod.ml<- rma.mv(yti ~ sd_winter,vi, random = ~ 1 | order/spec/popid, data=studies, method = "ML") 
modnull.ml<-rma.mv(yti ~ 1, vi, random = ~(1|order/spec/popid), data = studies, method = "ML") 
```
_summary statistics_    
```{r sdw_sumstat}

#estimate +se
summary(mod)
#Model Results:#

#intrcpt      2.0465  0.3172   6.4527  <.0001   1.4249   2.6681  ***
#sd_winter   -0.1203  0.0188  -6.3927  <.0001  -0.1571  -0.0834  ***
transf.ilogit(-0.1203)# 0.4699612


#nakagawas R²
(modnull$sigma2-mod$sigma2)/modnull$sigma2  # -1.280828e+07  5.737585e-01  5.603210e-01
(sum(modnull$sigma2)-sum(mod$sigma2))/sum(modnull$sigma2) #0.5137324

#significance testing
anova(mod.ml,modnull.ml) #LRT ratio =  34.2463, p<.0001
AIC(mod.ml)-AIC(modnull.ml)#  -32.24626

```
plot
```{r plot_sdwinter}

max.size<-(0.05/(2*1.96))^2; max.size <- 1/max.size 


studies$r <- r
svg("varc.svg",width=10,pointsize=12)
par(mar = c(5,5,0,0)+0.1)

plot(x=studies$sd_winter, y=studies$med_r, pch=21, cex= 0.3+1.5*(1/vi)/max.size , col=1, bg=studies$col, main = "", xlab = "Winter unpredictability", ylab = "Ratio of varaiance components",bty="n", cex.axis = 1.5, cex.lab=1.5,xlim=c(0,25), ylim=c(0,1)) #cex again set so that max ptsize = 2
#legend("bottomright",legend=names(n), col=rep(1,8), pt.bg=unique(studies$col), pch=21, bty="n", ncol=1,cex=1.5)
coffs <-  coef(mod)
lines(x= x,y=transf.ilogit(y),lwd=2)

#433*(1/0.1)/sum(r) = 0.8869712
segments(x0=studies$sd_winter[studies$r< 0.1],y0 = studies$lower_r[studies$r<.1],y1=studies$upper_r[studies$r<0.1],col="darkgrey") #credible intervals > 0.1 not shown 
studies$cex <- 0.3+1.5*(1/vi)/max.size
ord<-studies[order(studies$r,as.numeric(studies$order),decreasing = c(T,F), method = "radix"),] #to make sure smalles points are printed last, on top of the larger points. order is included so that dipterns do not completely dominate pic

for (i in 1:nrow(ord)){
  points(x=ord$sd_winter[i] ,y=ord$med_r[i], pch=21, col=1, bg=ord$col[i], cex=ord$cex[i])
}
dev.off()
```



### 6. Variance composition vs. temperature predictability  
```{r}

varc_tp <- rma.mv(yti ~ beta, vti, random = ~ 1 | order/spec/popid, data=studies)

plot(rstandard(varc_tp)$z, pch=19)
plot(studies$beta, studies$yti, pch=19)
x<-seq(5,25,length.out=1000) #will be used to plot prediction line
 y=coef(varc_tp)[1]+x*coef(varc_tp)[2] #inverse logit transform this to get prediction

 
 #null models and ML models (weighted)
#null models are in workspace already
varc_tp.ml<- rma.mv(yti ~ beta ,vi, random = ~ 1 | order/spec/popid, data=studies, method = "ML") 


#summary statistics
#estimate +se
summary(varc_tp)
#intrcpt    0.8820  0.2460   3.5848  0.0003   0.3998  1.3642  ***
#beta      -0.1886  0.3309  -0.5702  0.5686  -0.8371  0.4598     
transf.ilogit(-0.1886)# 0.4529893


#nakagawas R²
(modnull$sigma2-varc_tp$sigma2)/modnull$sigma2  # -4.748462e+06  4.324297e-01  5.151490e-01
(sum(modnull$sigma2)-sum(varc_tp$sigma2))/sum(modnull$sigma2) #0.4589706

#significance testing
anova(varc_tp.ml,modnull.ml) #LRT ratio =  0.0545, p=0.82
AIC(varc_tp.ml)-AIC(modnull.ml)#  1.945543
x<-seq(min(studies$beta),max(studies$beta),length.out=1000)
 y=coef(mod)[1]+x*coef(varc_tp)[2] #inverse logit transform this to get prediction
```

```{r plot_beta}

max.size<-(0.05/(2*1.96))^2; max.size <- 1/max.size 


studies$r <- r
svg("var_beta.svg",width=10,pointsize=12)
par(mar = c(5,5,0,0)+0.1)

plot(x=studies$beta, y=studies$med_r, pch=21, cex= 0.3+1.5*(1/vi)/max.size , col=1, bg=studies$col, main = "", xlab = "Temperature unpredictability", ylab = "Ratio of varaiance components",bty="n", cex.axis = 1.5, cex.lab=1.5,xlim=c(-1,1.5), ylim=c(0,1)) #cex again set so that max ptsize = 2
#legend("bottomright",legend=names(n), col=rep(1,8), pt.bg=unique(studies$col), pch=21, bty="n", ncol=1,cex=1.5)
lines(x= x,y=transf.ilogit(y),lwd=2)


segments(x0=studies$beta[studies$r< 0.1],y0 = studies$lower_r[studies$r<.1],y1=studies$upper_r[studies$r<0.1],col="darkgrey") #credible intervals > 0.1 not shown 
studies$cex <- 0.3+1.5*(1/vi)/max.size
ord<-studies[order(studies$r,as.numeric(studies$order),decreasing = c(T,F), method = "radix"),] #to make sure smalles points are printed last, on top of the larger points. order is included so that dipterns do not completely dominate pic

for (i in 1:nrow(ord)){
  points(x=ord$beta[i] ,y=ord$med_r[i], pch=21, col=1, bg=ord$col[i], cex=ord$cex[i])
}
dev.off()
```


### 7. conservative bet-hedging  
```{r}
studies$res_varc <- rstandard(mod)$z
studies$res_mw<-rstandard(mw)$z
cbh<- rma.uni(res_mw ,vi, mod  = res_varc ,data=studies) 

summary(cbh)
#estimate      se    zval    pval    ci.lb   ci.ub   
#intrcpt    0.0876  0.0466  1.8816  0.0599  -0.0037  0.1789  .
#mods       0.0077  0.0447  0.1726  0.8630  -0.0798  0.0952   

#R² = 0
anova(cbh)#0.0298, p-val = 0.8630
#AIC diff: 0.1996261

svg("cbh.svg",width=10,pointsize=12)
par(mar = c(5,5,0,0)+0.1)
plot(res_mw ~ res_varc, pch=21, cex= 0.3+1.5*(1/vi)/max.size , col=1, bg=studies$col, main = "", ylab = "Residulas diapause timing", xlab = "Residuals variance composition",bty="n", cex.axis = 1.5, cex.lab=1.5,xlim=c(-3,3.5), ylim=c(-3,3)) #cex again set so that max ptsize = 2
#legend("bottomright",legend=names(n), col=rep(1,8), pt.bg=unique(studies$col), pch=21, bty="n", ncol=1,cex=1.5)
x<-seq(min(res_varc),max(res_varc), length.out=1000)
y<-coef(cbh)[1]+coef(cbh)[2]*x
lines(y~x,lwd=2)
dev.off()
```

### how do these climate pics change with parameters?  
The following chunk correlates day length at winter onset with latitude, for a variety of parameter combinations (currently commented out). It also saves the slope estimates.
It is currently disabled so that the script is not slowed down. in addition, running it will reload the climate data and erase all changes (e.g. climate$dl)
```{r sensitivity}
dontrun<-function(){
threshlist <-seq(0,150,5)
t2list <-5#c(5,10,15)
Z<-1
coeflist<-rep(NA,length(threshlist)*length(t2list))


for(threloop in 1:length(threshlist)){
  threshold<-threshlist[threloop]
  for (t2loop in 1:length(t2list)){
    t2<-t2list[t2loop]
    reslist<-read.table(paste("01climate_data/03output/results_",threshold,"-",t2,".txt",sep=""))
    names(reslist)<-c("ID","meanwinter","sd_winter","p","nyears","ndays_300","ndays_350","ndays_365")
    climate<-merge(locations,reslist,by=1)
rm(reslist)
names(climate)<-c("ID","lat","lon","alt","name","no_idea","meanwinter","sd_winter",   "p", "nyears" , "ndays_300"  ,"ndays_350",  "ndays_365" )

climate<-climate[!is.na(climate$meanwinter),] 
climate<-climate[climate$lat<70,]
climate<-climate[climate$lat>20,]


climate$expdl<-daylength(climate$lat,climate$meanwinter+182)
coeflist[Z]<-coef(lm(climate$expdl~climate$lat))[2]

#png(paste("results_",threshold,"-",t2,".png",sep=""))
#plot(climate$expdl~climate$lat,pch=22,bg=1,col=NA,cex=0.1)
#abline(lm(climate$expdl~climate$lat),col=2)
#text(x=min(climate$lat)+5,y= min(climate$expdl)+1,paste("slope:",round(coeflist[Z],2)*5))
#text(x=60,y=min(climate$expdl)+1,paste("median winter:",182+round(median(climate$meanwinter))))
#dev.off()

Z<-Z+1
}}

svg("slope_par.svg",pointsize=12)
par(mar=c(5,5,3,2)+0.1)
plot(x=threshlist/10, y=coeflist[seq(1,length(threshlist)*length(t2list),length(t2list))]*5, xlab="T threshold (°C)", ylab="Slope coefficient (h/5°N)", bty="n", type="l", lwd=3, yaxt="n", cex.lab=1.5, cex.axis=1.5,ylim=range(coeflist)*5)
for (lin in 1:length(t2list)){
  lines(x=threshlist/10,y=coeflist[seq(lin,length(threshlist)*length(t2list),length(t2list))]*5,col=col_def[lin],lwd=3,lty=lin)
}
axis(2,at=c(-0.5,0,0.5,1,1.5), cex.axis=1.5)
dev.off()
}
```

