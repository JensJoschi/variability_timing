---
title: "read slopes"
author: "Jens Joschinski"
date: "March 15, 2018"
output: 
  md_document:
  variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
library(tidyverse)
library(textreadr)
library(drc)
library(sandwich)
library(lmtest)
```


# General description  
## Aim  
The aim of this project is to correlate climate variability with variability in seasonal timing. Is the slope in seasonal responses a bet-hedging trait, i.e., is it adaptive to spread one's timing in more variable conditions?  


### Overview  
I searched in the web of Science database for studies that measure photoperiodic response curves of invertebrates (folder 02studies/00raw) and extracted the x- and y-coordinates of the points within these curves (folder 02studies/01extracted_data). After adding metadata (latitudes, longitudes,sample sizes, "extracted.xlsx"") I copied a subset of the data into a csv file. The script now calculates the slope and other parameters of the photopeirodic response curve. It uses dose-response curves analysis with package "drc".  

### Specific description  

The data was generated with R version `r getRversion()`. Slope estimates derived with package drc, `r citation('drc')`.



###Script  

Need to run a script for each group (= for each study) to calculate dose-response curves

The following chunk cannot be run directly, but has to be copied to the console (otherwise some trouble in optim will occur)

```{r}
data<-read.table("02studies/01extracted_data/forslopes.csv", header=T,sep="\t")
data<-data[data$cdl=="x",]
data<-separate(data,col=1, into = c("study","pop"), sep ="-",remove=FALSE)
length(unique(data$study)) #52 studies that can be used for CDL calculation
length(unique(data$line.ID)) #353 populations
length(unique(data$study[data$slope=="x"])) # 30 studies can be used for slope calculation
length(unique(data$line.ID[data$slope=="x"]))#170 populations

r<-data.frame(NA,NA,NA,NA,NA,NA,NA,NA,NA)
names(r)<-c("name","b","b_rel","c","c_rel","d","d_rel","e","e_rel") #the results will be stored in a file with these columns

for (i in 1:length(unique(data$study))){
sub<-data[data$study==unique(data$study)[i],] #calculate dose response curves for each study seperately
sub<-droplevels(sub)
sub$perc[sub$perc<0]<-0
sub$perc[sub$perc>100]<-100
sub$number<-round(sub$n2 * sub$perc/100)


moo <- drm(number/n2~dl2,curveid=line.ID,data=sub,fct=LL.4(),type="binomial",upperl=c(NA,NA,1,NA),lowerl=c(NA,0,NA,NA),control=drmc(method="L-BFGS-B"),weights=n2)
#drm weighted by samplesize and ranging from 0 to 1 (the range is estimated between 0 and 1, not fixed)
moo2 <- drm(number/n2~dl2,curveid=line.ID,data=sub,fct=LL.3u(),type="binomial",control=drmc(method="L-BFGS-B"),weights=n2)
#drm weighted by samplesize and ranging from 0 to 1 (the range is estimated between 0 and 1, not fixed)


#to add here: if the 3-parameter DRC with variable upper limit (drcs go from 0-something) is better, use that. If the 2-parameter is still better, use that. though be more careful in changnig to 2-parameter curve. 


png(paste("02studies/01extracted_data/",i,"-",unique(data$study)[i],".png",sep="")) #plot each study for visual validation
plot(moo, broken = TRUE, type = "all", xlab = "Day length", ylab = "percentage diapause",main = sub$study[1],sub = "dose response curve estimates",log="",col=TRUE)
dev.off()

coffs<-coeftest(moo,vcov = sandwich)[,1:2] #provides estimate and SE
coffs[,2]<-1/coffs[,2] #SE becomes 1/SE, as these are later weights
npop=length(unique(sub$line.ID))
n<-unique(sub$line.ID)

for (j in 1:npop){
  r[nrow(r)+1,]<-c(as.character(n[j]),coffs[j,],coffs[j+npop,],coffs[j+2*npop,],coffs[j+3*npop,])#writes results for each pop in this study into results: ID, b, c,d,e, and the weights of each
}
}#next study


#transport all other metadata from csv file to results file
r$degN<-NA
r$degE<-NA
r$order<-NA
r$genus<-NA
r$species<-NA
r$pops_with_dia<-NA
r$n_dls<-NA
r$py<-NA
r$slopable<-NA

for(i in 1:nrow(r)){
  r[i,10]<-as.character(data[data$line.ID == r[i,1],10][1])#degN
  r[i,11]<-as.character(data[data$line.ID == r[i,1],11][1])#degE
  r[i,12]<-as.character(data[data$line.ID == r[i,1],9][1])#order
  r[i,13]<-as.character(data[data$line.ID == r[i,1],7][1])#genus
  r[i,14]<-as.character(data[data$line.ID == r[i,1],8][1])#species
  r[i,15]<-as.character(data[data$line.ID == r[i,1],5][1])#pops_with_dia
  r[i,16]<-as.character(data[data$line.ID == r[i,1],6][1])#n_dls
  r[i,17]<-as.character(data[data$line.ID == r[i,1],15][1])#py
  r[i,18]<-as.character(data[data$line.ID == r[i,1],17][1])#slope
}

write.table(r, "02studies/02output/slopes.txt")

#testing
npop=length(unique(sub$line.ID))
#predict curves by hand
b<-coef(moo)[1:npop] # there are three parameters per pop - the first third are the b estimates, the second third the d estimates (upper bound), and the last third the e estimate (critical day length)
c<- coef(moo)[(npop+1):(2*npop)]
d<- coef(moo)[(npop*2+1):(3*npop)]
e<- coef(moo)[(npop*3+1):length(coef(moo))]

lin <- function(x,b,c,d,e){
  upper<-d-c
  lower <-1 + exp(b*(log(x)-log(e)))
  c+ (upper/lower)
}

bm<-b-coffs[1:npop,2]
cm<-c-coffs[(npop+1):(npop*2),2]
dm<-d-coffs[(npop*2+1):(npop*3),2]
em<-e-coffs[(npop*3+1):(npop*4),2]
plot(moo)
lines(x=1:16,y = lin(1:16,b[i],c[i],d[i],e[i]),col=2)
lines(x=1:16,y = lin(1:16,bm[i],cm[i],dm[i],em[i]),col=4)
```

